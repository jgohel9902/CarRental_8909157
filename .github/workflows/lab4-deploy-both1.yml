name: Lab 4 - Deploy MVC + WebAPI to Azure (Kudu ZipDeploy)

# ---------------------------------------------
# Triggers
# ---------------------------------------------
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# ---------------------------------------------
# Global environment variables (paths to your .csproj files)
# Update these if your folder names differ.
# ---------------------------------------------
env:
  MVC_PROJECT: CarRentalApp/CarRentalApp.csproj
  API_PROJECT: Maintenance.WebAPI/Maintenance.WebAPI.csproj

jobs:
  build-and-deploy:
    name: Build + Deploy MVC and WebAPI
    runs-on: windows-latest

    steps:
      # ---------------------------------------------
      # 1) Get source code from your GitHub repo
      # ---------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------
      # 2) Install .NET SDK (Lab uses .NET 8 runtime in Azure)
      # ---------------------------------------------
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      # ---------------------------------------------
      # 3) Restore dependencies (NuGet packages) for both projects
      # ---------------------------------------------
      - name: Restore MVC dependencies
        run: dotnet restore "${{ env.MVC_PROJECT }}"

      - name: Restore WebAPI dependencies
        run: dotnet restore "${{ env.API_PROJECT }}"

      # ---------------------------------------------
      # 4) Build both projects in Release mode
      # ---------------------------------------------
      - name: Build MVC (Release)
        run: dotnet build "${{ env.MVC_PROJECT }}" -c Release --no-restore

      - name: Build WebAPI (Release)
        run: dotnet build "${{ env.API_PROJECT }}" -c Release --no-restore

      # ---------------------------------------------
      # 5) Publish both projects (creates the deployable output)
      #    We publish into separate folders so nothing overwrites.
      # ---------------------------------------------
      - name: Publish MVC
        run: dotnet publish "${{ env.MVC_PROJECT }}" -c Release --no-build -o publish_mvc

      - name: Publish WebAPI
        run: dotnet publish "${{ env.API_PROJECT }}" -c Release --no-build -o publish_api

      # ---------------------------------------------
      # 6) Zip the publish outputs (ZipDeploy requires a zip package)
      # ---------------------------------------------
      - name: Create MVC zip package
        shell: pwsh
        run: |
          if (Test-Path "mvc.zip") { Remove-Item "mvc.zip" -Force }
          Compress-Archive -Path "publish_mvc\*" -DestinationPath "mvc.zip" -Force

      - name: Create WebAPI zip package
        shell: pwsh
        run: |
          if (Test-Path "api.zip") { Remove-Item "api.zip" -Force }
          Compress-Archive -Path "publish_api\*" -DestinationPath "api.zip" -Force

      # ---------------------------------------------
      # 7) Deploy MVC using Kudu ZipDeploy (NO OneDeploy)
      #    We extract SCM URL + username/password from the publish profile XML.
      # ---------------------------------------------
      - name: Deploy MVC to Azure (Kudu ZipDeploy)
        shell: pwsh
        env:
          PUBLISH_PROFILE_XML: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_MVC }}
        run: |
          # Publish profile XML is stored in GitHub secret
          [xml]$pp = $env:PUBLISH_PROFILE_XML

          # Choose the ZipDeploy publishProfile node (publishMethod="ZipDeploy")
          $zipNode = $pp.publishData.publishProfile | Where-Object { $_.publishMethod -eq "ZipDeploy" } | Select-Object -First 1
          if (-not $zipNode) { throw "No ZipDeploy publish profile found for MVC secret." }

          # publishUrl looks like: something.scm.azurewebsites.net:443
          $publishUrl = [string]$zipNode.publishUrl
          $kuduHost = ($publishUrl -split ":")[0]  # avoid using $Host (reserved in PowerShell)
          $zipDeployUrl = "https://$kuduHost/api/zipdeploy?isAsync=true"

          $user = [string]$zipNode.userName
          $pass = [string]$zipNode.userPWD

          Write-Host "Deploying MVC to: $zipDeployUrl"

          # Basic Auth header
          $pair = "$user`:$pass"
          $bytes = [System.Text.Encoding]::ASCII.GetBytes($pair)
          $token = [Convert]::ToBase64String($bytes)
          $headers = @{ Authorization = "Basic $token" }

          # Upload zip to Kudu ZipDeploy
          Invoke-RestMethod -Uri $zipDeployUrl -Headers $headers -Method POST -InFile "mvc.zip" -ContentType "application/zip"

      # ---------------------------------------------
      # 8) Deploy WebAPI using Kudu ZipDeploy (NO OneDeploy)
      # ---------------------------------------------
      - name: Deploy WebAPI to Azure (Kudu ZipDeploy)
        shell: pwsh
        env:
          PUBLISH_PROFILE_XML: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}
        run: |
          [xml]$pp = $env:PUBLISH_PROFILE_XML
          $zipNode = $pp.publishData.publishProfile | Where-Object { $_.publishMethod -eq "ZipDeploy" } | Select-Object -First 1
          if (-not $zipNode) { throw "No ZipDeploy publish profile found for API secret." }

          $publishUrl = [string]$zipNode.publishUrl
          $kuduHost = ($publishUrl -split ":")[0]
          $zipDeployUrl = "https://$kuduHost/api/zipdeploy?isAsync=true"

          $user = [string]$zipNode.userName
          $pass = [string]$zipNode.userPWD

          Write-Host "Deploying WebAPI to: $zipDeployUrl"

          $pair = "$user`:$pass"
          $bytes = [System.Text.Encoding]::ASCII.GetBytes($pair)
          $token = [Convert]::ToBase64String($bytes)
          $headers = @{ Authorization = "Basic $token" }

          Invoke-RestMethod -Uri $zipDeployUrl -Headers $headers -Method POST -InFile "api.zip" -ContentType "application/zip"
