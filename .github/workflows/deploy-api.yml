name: Deploy WebAPI to Azure (Kudu ZipDeploy)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PROJECT_PATH: Maintenance.WebAPI/Maintenance.WebAPI.csproj
  PUBLISH_FOLDER: publish_api
  ZIP_NAME: api.zip

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      # 3️⃣ Restore dependencies
      - name: Restore packages
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      # 4️⃣ Build project
      - name: Build project
        run: dotnet build "${{ env.PROJECT_PATH }}" -c Release --no-restore

      # 5️⃣ Publish compiled output
      - name: Publish project
        run: dotnet publish "${{ env.PROJECT_PATH }}" -c Release --no-build -o "${{ env.PUBLISH_FOLDER }}"

      # 6️⃣ Zip the publish output
      - name: Zip publish output
        shell: pwsh
        run: |
          if (Test-Path "${{ env.ZIP_NAME }}") { Remove-Item "${{ env.ZIP_NAME }}" -Force }
          Compress-Archive -Path "${{ env.PUBLISH_FOLDER }}\*" -DestinationPath "${{ env.ZIP_NAME }}"

      # 7️⃣ Deploy to Azure via Kudu ZipDeploy
      - name: Deploy to Azure Web App
        shell: pwsh
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}
        run: |
          $ppPath = "publishProfile.xml"
          $env:PUBLISH_PROFILE | Out-File -FilePath $ppPath -Encoding utf8
          [xml]$xml = Get-Content $ppPath

          $zipNode = $xml.publishData.publishProfile | Where-Object { $_.publishMethod -eq "ZipDeploy" } | Select-Object -First 1

          $publishUrl = $zipNode.publishUrl
          $userName   = $zipNode.userName
          $userPwd    = $zipNode.userPWD

          $kuduHost = $publishUrl.Split(":")[0]
          $zipDeployUrl = "https://$kuduHost/api/zipdeploy"

          $pair = "$userName`:$userPwd"
          $bytes = [System.Text.Encoding]::ASCII.GetBytes($pair)
          $basic = [Convert]::ToBase64String($bytes)

          Write-Host "Deploying to: $zipDeployUrl"
          $headers = @{ Authorization = "Basic $basic" }

          Invoke-RestMethod -Uri $zipDeployUrl -Headers $headers -Method POST -InFile "${{ env.ZIP_NAME }}" -ContentType "application/zip"

          Write-Host "Deployment successful"
